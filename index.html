<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Target</title>
    <style>
        :root {
            --primary: #007AFF;
            --bg: #f2f2f7;
            --card: #ffffff;
            --text: #333;
            --danger: #ff3b30;
            --success: #34c759;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        /* ÂÖ±ÈÄö„É¨„Ç§„Ç¢„Ç¶„Éà */
        .screen {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        header {
            background: var(--card);
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1rem;
            cursor: pointer;
        }

        /* „Éõ„Éº„É†ÁîªÈù¢ÔºàDay‰∏ÄË¶ßÔºâ */
        .day-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }

        .day-item {
            background: var(--card);
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .day-item:active {
            background: #e5e5ea;
        }

        .progress-circle {
            font-size: 0.8rem;
            color: #888;
        }

        .progress-circle.done {
            color: var(--success);
            font-weight: bold;
        }

        /* Â≠¶ÁøíÁîªÈù¢ */
        .study-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .word-card {
            background: var(--card);
            width: 100%;
            max-width: 400px;
            border-radius: 16px;
            padding: 30px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .word-en {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            color: #000;
        }

        .word-phonetic {
            color: #666;
            font-family: "Lucida Sans Unicode", sans-serif;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .word-ja {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary);
            margin: 15px 0;
            display: none;
        }

        /* ÂàùÊúü„ÅØÈö†„Åô */
        .word-sentence {
            font-size: 0.9rem;
            color: #555;
            margin-top: 15px;
            text-align: left;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }

        .word-sentence em {
            font-weight: bold;
            font-style: normal;
            color: #000;
        }

        /* 4Êäû„ÇØ„Ç§„Ç∫Áî® */
        .quiz-options {
            width: 100%;
            max-width: 400px;
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-btn {
            background: var(--card);
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 10px;
            font-size: 1rem;
            text-align: left;
            cursor: pointer;
            transition: 0.2s;
        }

        .quiz-btn:active {
            background: #ddd;
        }

        .quiz-btn.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .quiz-btn.wrong {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* „Ç≥„É≥„Éà„É≠„Éº„É´„Ç®„É™„Ç¢ */
        .controls {
            display: flex;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            justify-content: center;
            margin-top: auto;
            padding-bottom: 30px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-answer {
            background: var(--primary);
            color: white;
        }

        .btn-next {
            background: #333;
            color: white;
            display: none;
        }

        /* ÂàùÊúü„ÅØÈö†„Åô */

        .speaker-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            color: var(--primary);
            cursor: pointer;
        }

        .check-area {
            position: absolute;
            top: 15px;
            left: 15px;
        }

        .check-input {
            transform: scale(1.5);
        }

        /* „É¢„Éº„ÉâÂàáÊõø„Çø„Éñ */
        .mode-tabs {
            display: flex;
            background: #e0e0e0;
            border-radius: 10px;
            padding: 3px;
            margin: 10px auto;
            width: 90%;
            max-width: 300px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            color: #666;
        }

        .tab.active {
            background: white;
            color: var(--text);
            font-weight: bold;
            shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>

    <div id="home-screen" class="screen active">
        <header>
            <span>My Target</span>
            <span style="font-size:0.8rem; color:#666;" id="total-progress">0%</span>
        </header>
        <ul class="day-list" id="day-list">
        </ul>
    </div>

    <div id="study-screen" class="screen">
        <header>
            <button class="back-btn" onclick="goHome()">‚Äπ Êàª„Çã</button>
            <span id="current-day-title">Day 1</span>
            <span style="width:30px"></span>
        </header>

        <div class="mode-tabs">
            <div class="tab active" onclick="setMode('card')">„Ç´„Éº„Éâ</div>
            <div class="tab" onclick="setMode('quiz')">4Êäû„ÇØ„Ç§„Ç∫</div>
        </div>

        <div class="study-container">
            <div class="word-card" id="word-card">
                <div class="check-area">
                    <input type="checkbox" class="check-input" id="memorized-check" onchange="toggleMemorized()">
                </div>
                <div class="speaker-icon" onclick="playAudio()">üîä</div>

                <div class="word-en" id="disp-en">Apple</div>
                <div class="word-phonetic" id="disp-phonetic">/«Ωpl/</div>

                <div class="word-ja" id="disp-ja">„É™„É≥„Ç¥</div>
                <div class="word-sentence" id="disp-sentence">
                    <div style="font-size:0.8rem; color:#888; margin-bottom:4px;">‰æãÊñá:</div>
                    <span id="sentence-en">This is an apple.</span>
                    <hr style="border:0; border-top:1px solid #eee; margin:5px 0;">
                    <span id="sentence-ja" style="font-size:0.85rem; color:#666;">„Åì„Çå„ÅØ„É™„É≥„Ç¥„Åß„Åô</span>
                </div>
            </div>

            <div class="quiz-options" id="quiz-options">
                <button class="quiz-btn" onclick="checkQuiz(0)"></button>
                <button class="quiz-btn" onclick="checkQuiz(1)"></button>
                <button class="quiz-btn" onclick="checkQuiz(2)"></button>
                <button class="quiz-btn" onclick="checkQuiz(3)"></button>
            </div>

            <div class="controls">
                <button class="btn btn-answer" id="btn-action" onclick="handleAction()">Á≠î„Åà„ÇíË¶ã„Çã</button>
                <button class="btn btn-next" id="btn-next" onclick="nextWord()">Ê¨°„Å∏</button>
            </div>
        </div>
    </div>

    <script>
        // --- „Éá„Éº„ÇøÁÆ°ÁêÜ ---
        let allWords = [];
        let currentDayWords = [];
        let currentIndex = 0;
        let currentMode = 'card'; // 'card' or 'quiz'
        let memorizedData = JSON.parse(localStorage.getItem('myTargetMemorized')) || {};

        // Ëµ∑ÂãïÊôÇ
        window.onload = async function () {
            try {
                // data.json„ÅÆË™≠„ÅøËæº„Åø
                const response = await fetch('data.json');
                allWords = await response.json();
                renderDayList();
            } catch (e) {
                alert('data.json„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂêå„Åò„Éï„Ç©„É´„ÉÄ„Å´ÈÖçÁΩÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        };

        // „Éõ„Éº„É†ÁîªÈù¢: Day„É™„Çπ„ÉàÁîüÊàê
        function renderDayList() {
            const list = document.getElementById('day-list');
            list.innerHTML = '';

            // Day„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const days = {};
            allWords.forEach(word => {
                if (!days[word.day]) days[word.day] = [];
                days[word.day].push(word);
            });

            // „É™„Çπ„ÉàË°®Á§∫
            Object.keys(days).sort((a, b) => a - b).forEach(day => {
                const words = days[day];
                const count = words.length;
                // Ë¶ö„Åà„ÅüÊï∞
                const doneCount = words.filter(w => memorizedData[w.id]).length;
                const percent = Math.round((doneCount / count) * 100);

                const li = document.createElement('li');
                li.className = 'day-item';
                li.innerHTML = `
                <div>
                    <span style="font-weight:bold; font-size:1.1rem;">Day ${day}</span>
                    <span style="font-size:0.8rem; color:#666; margin-left:10px;">(${count}Ë™û)</span>
                </div>
                <div class="progress-circle ${percent === 100 ? 'done' : ''}">${percent}% ÂÆå‰∫Ü</div>
            `;
                li.onclick = () => startDay(day, words);
                list.appendChild(li);
            });

            // ÂÖ®‰Ωì„ÅÆÈÄ≤Êçó
            const totalDone = Object.keys(memorizedData).length;
            const totalPercent = Math.round((totalDone / allWords.length) * 100);
            document.getElementById('total-progress').innerText = `Total: ${totalPercent}%`;
        }

        // Â≠¶ÁøíÈñãÂßã
        function startDay(day, words) {
            currentDayWords = words;
            currentIndex = 0;

            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('study-screen').classList.add('active');
            document.getElementById('current-day-title').innerText = `Day ${day}`;

            showWord();
        }

        // „Éõ„Éº„É†„Å´Êàª„Çã
        function goHome() {
            document.getElementById('study-screen').classList.remove('active');
            document.getElementById('home-screen').classList.add('active');
            renderDayList(); // ÈÄ≤ÊçóÊõ¥Êñ∞„ÅÆ„Åü„ÇÅÂÜçÊèèÁîª
        }

        // „É¢„Éº„ÉâÂàáÊõø
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[mode === 'card' ? 0 : 1].classList.add('active');

            // ÁîªÈù¢„É™„Çª„ÉÉ„Éà
            showWord();
        }

        /**
         * „Äê‰øÆÊ≠£ÁÆáÊâÄ„Äë
         * ÂçòË™û„ÇíÊåáÂÆö„Åó„Å¶„ÄåË¶ö„Åà„Åü„Äç„Å®„Åó„Å¶„Éû„Éº„ÇØ„Åó„ÄÅ‰øùÂ≠ò„Åô„Çã
         */
        function markAsMemorized(wordId) {
            if (!memorizedData[wordId]) {
                memorizedData[wordId] = true;
                localStorage.setItem('myTargetMemorized', JSON.stringify(memorizedData));

                // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆÂçòË™û„Åß„ÅÇ„Çå„Å∞„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇÇÂêåÊúü„Åï„Åõ„Çã
                const currentItem = currentDayWords[currentIndex];
                if (currentItem && currentItem.id === wordId) {
                    document.getElementById('memorized-check').checked = true;
                }
            }
        }


        // ÂçòË™ûË°®Á§∫ÔºàÂÖ±ÈÄöÔºâ
        function showWord() {
            if (currentIndex >= currentDayWords.length) {
                alert('„Åì„ÅÆDay„ÅØÁµÇ‰∫Ü„Åß„ÅôÔºÅ');
                goHome();
                return;
            }

            const item = currentDayWords[currentIndex];

            // DOMË¶ÅÁ¥†
            const elEn = document.getElementById('disp-en');
            const elPhonetic = document.getElementById('disp-phonetic');
            const elJa = document.getElementById('disp-ja');
            const elSent = document.getElementById('disp-sentence');
            const elSentEn = document.getElementById('sentence-en');
            const elSentJa = document.getElementById('sentence-ja');
            const check = document.getElementById('memorized-check');
            const quizArea = document.getElementById('quiz-options');
            const btnAction = document.getElementById('btn-action');
            const btnNext = document.getElementById('btn-next');

            // „Éá„Éº„Çø„Çª„ÉÉ„Éà
            elEn.innerText = item.en;
            elPhonetic.innerText = item.phonetic || "";
            elJa.innerText = item.ja;

            // ‰æãÊñá„Åå„ÅÇ„ÇãÂ†¥Âêà
            if (item.sentence) {
                elSentEn.innerText = item.sentence;
                elSentJa.innerText = item.sentence_ja || "";
            } else {
                elSentEn.innerText = "No example sentence.";
                elSentJa.innerText = "";
            }

            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÁä∂ÊÖã
            check.checked = !!memorizedData[item.id];

            // Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
            elJa.style.display = 'none';
            elSent.style.display = 'none';
            btnNext.style.display = 'none';
            btnAction.style.display = 'block';
            btnAction.innerText = 'Á≠î„Åà„ÇíË¶ã„Çã';
            btnAction.disabled = false;

            // „É¢„Éº„ÉâÂà•Ë°®Á§∫
            if (currentMode === 'card') {
                quizArea.style.display = 'none';
            } else {
                // „ÇØ„Ç§„Ç∫„É¢„Éº„Éâ
                quizArea.style.display = 'flex';
                btnAction.style.display = 'none'; // „ÇØ„Ç§„Ç∫„Åß„ÅØ„Éú„Çø„É≥„Åß„ÅØ„Å™„ÅèÈÅ∏ÊäûËÇ¢„ÇíÊäº„Åô
                generateQuiz(item);
            }
        }

        // „ÇØ„Ç§„Ç∫ÁîüÊàê
        function generateQuiz(correctItem) {
            // „ÉÄ„Éü„Éº„ÅÆÈÅ∏ÊäûËÇ¢„Çí3„Å§ÈÅ∏„Å∂ÔºàÂêå„ÅòDayÂÜÖ„Åæ„Åü„ÅØÂÖ®‰Ωì„Åã„ÇâÔºâ
            const others = allWords.filter(w => w.id !== correctItem.id);
            const dummies = [];
            while (dummies.length < 3) {
                const r = others[Math.floor(Math.random() * others.length)];
                if (!dummies.includes(r)) dummies.push(r);
            }

            // Ê≠£Ëß£„ÇíÂê´„ÇÅ„Å¶„Ç∑„É£„ÉÉ„Éï„É´
            const options = [correctItem, ...dummies].sort(() => Math.random() - 0.5);

            // „Éú„Çø„É≥„Å´„Çª„ÉÉ„Éà
            const btns = document.querySelectorAll('.quiz-btn');
            btns.forEach((btn, i) => {
                btn.innerText = options[i].ja;
                btn.className = 'quiz-btn'; // „ÇØ„É©„Çπ„É™„Çª„ÉÉ„Éà
                btn.disabled = false; // ÁÑ°ÂäπÂåñ„É™„Çª„ÉÉ„Éà
                btn.onclick = () => {
                    // ÂÖ®„Å¶„ÅÆ„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñÔºà‰∫åÈáçÊäº„ÅóÈò≤Ê≠¢Ôºâ
                    btns.forEach(b => b.disabled = true);

                    // Ê≠£Ëß£Âà§ÂÆö
                    if (options[i].id === correctItem.id) {
                        btn.classList.add('correct');
                        markAsMemorized(correctItem.id); // ‚òÖ„ÇØ„Ç§„Ç∫Ê≠£Ëß£ÊôÇ„Å´Ë¶ö„Åà„Åü„Åì„Å®„Å´„Åô„Çã‚òÖ
                        playAudio(); // Ê≠£Ëß£„Åó„Åü„ÇâÁô∫Èü≥
                    } else {
                        btn.classList.add('wrong');
                        // Ê≠£Ëß£„ÇÇË°®Á§∫„Åó„Å¶„ÅÇ„Åí„Çã
                        const correctIndex = options.findIndex(o => o.id === correctItem.id);
                        btns[correctIndex].classList.add('correct');
                    }
                    revealAnswer();
                };
            });
        }

        // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥Ôºà„Ç´„Éº„Éâ„É¢„Éº„ÉâÁî®Ôºâ
        function handleAction() {
            playAudio();
            revealAnswer();
        }

        // Á≠î„Åà„ÇíË°®Á§∫„Åô„ÇãÂá¶ÁêÜ
        function revealAnswer() {
            document.getElementById('disp-ja').style.display = 'block';
            document.getElementById('disp-sentence').style.display = 'block';

            document.getElementById('btn-action').style.display = 'none';
            document.getElementById('btn-next').style.display = 'block';
        }

        // Ê¨°„Å∏
        function nextWord() {
            currentIndex++;
            showWord();
        }

        // Èü≥Â£∞ÂÜçÁîü (Web Speech API)
        function playAudio() {
            const item = currentDayWords[currentIndex];
            if (!item) return;

            // Ëã±Ë™û„ÅÆÁô∫Ë©±Ë®≠ÂÆö
            const u = new SpeechSynthesisUtterance(item.en);
            u.lang = 'en-US';
            u.rate = 1.0; // ÈÄüÂ∫¶
            speechSynthesis.cancel(); // Ââç„ÅÆ„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Å¶
            speechSynthesis.speak(u); // ÂÜçÁîü
        }

        /**
         * „Äê‰øÆÊ≠£ÁÆáÊâÄ„Äë
         * Ë¶ö„Åà„Åü„ÉÅ„Çß„ÉÉ„ÇØ„ÅÆ‰øùÂ≠òÔºàmarkAsMemorized()„Çí‰ΩøÁî®„Åô„Çã„Çà„ÅÜ„Å´Â§âÊõ¥Ôºâ
         */
        function toggleMemorized() {
            const item = currentDayWords[currentIndex];
            const check = document.getElementById('memorized-check');

            if (check.checked) {
                markAsMemorized(item.id);
            } else {
                // Ë¶ö„Åà„ÅüÁä∂ÊÖã„ÇíËß£Èô§
                if (memorizedData[item.id]) {
                    delete memorizedData[item.id];
                    localStorage.setItem('myTargetMemorized', JSON.stringify(memorizedData));
                }
            }
        }
    </script>
</body>

</html>